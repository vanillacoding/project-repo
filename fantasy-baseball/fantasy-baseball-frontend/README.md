# FANTASY BASEBALL

![FantasyBaseballLogo](./readme-assets/fantasy-baseball-logo.png)

(메인이미지)

# 목차

- 개요
- 프로젝트 멤버

## 개요
- 판타지 스포츠와 베팅 시스템을 결합한 웹 애플리케이션입니다.
- 유저가 원하는 10인의 로스터로 베팅을 하여 당일 선수들의 경기 성적에 따라 배당금을 획득할 수 있는 시스템입니다.
- 개발 기간 : 2021년 4월 12일 (월) ~ 2021년 4월 30일 (금) 약 3주

## 개발 동기

- 야구를 좋아하는 사람, 야구를 좋아했던 사람, 게임을 좋아하는 사람 셋이 모여 판타지 스포츠에 대한 이야기를 나누다 판타지 스포츠와 베팅 시스템을 결합하면 재밌는 애플리케이션이 나올 것 같아 개발을 시작하게 되었습니다.
- 스포츠 종목 중 야구를 선택한 이유는 세이버매트릭스 등 **통계의 스포츠**라고 불리는 야구를 기반으로 개발하면 사용할 수 있는 데이터가 많기 때문에 이를 기반으로 다양한 작업을 할 수 있을 거라 생각했기 때문입니다.

## 프로젝트 멤버
- [박정빈](https://github.com/pjb6510): 베팅 이력, 로딩 스켈레톤, 크롤링, 스케쥴링, Backend 로깅
- [윤한솔](https://github.com/yoohaso): 로그인, 메일링, 로스터 UI, 모달, 경기 결과 스코어 계산
- [전유림](https://github.com/eluka22): 메인, 베팅 등록, 베팅 결과, 선수별 통계, 공통 컴포넌트 및 스타일 관리, 유저별 배당금 계산

## 기술 스택
### Frontend
- ES2015+
- React
- React-router-dom
- Redux
- Redux-Thunk
- redux-logger
- immer
- styled-component
- date-fns
- cross-env
- react-google-login
- react-loading-skeleton
- react-table


### Backend
- Express
- MongoDB Atlas
- NodeJS
- Puppeteer
- Node-Schedule
- nodemailer
- dotenv
- cross-env

## 시작하기
- ReadMe에 작성해야 하는지 확인 필요

### env 설정

1. Frontend

```shell
REACT_APP_API_ADDRESS=API_ADDRESS
REACT_APP_GOOGLE_CLIENT_ID=YOUR_GOOGLE_CLIENT_ID
```

2. Backend

- `MANAGER_EMAIL`: 유저들에게 자동으로 발송되는 메일링을 위한 이메일 주소입니다.

```shell
MONGO_DB=YOUR_MONGODB_URL
CLIENT_URL=CLIENT_URL
PORT=5000
GOOGLE_CLIENT_ID=YOUR_GOOGLE_CLIENT_ID
GOOGLE_CLIENT_SECRET=YOUR_GOOGLE_CLIENT_SECRET
REDIRECT_URL=https://developers.google.com/oauthplayground
REFRESH_TOKEN=
MANAGER_EMAIL=YOUR_MANAGER_EMAIL
```

## 사용 방법

### 로그인

- 우측의 `PLAY BALL` 버튼을 클릭하여 FANTASY BASEBALL에 로그인할 수 있습니다.
- 로그인 방식은 구글 소셜 로그인입니다.

### 메인

- 로그인 후 메인 페이지에 접근하며, 당일 경기 스케쥴 및 랭킹 정보를 확인할 수 있습니다.
- 상단에는 당일 진행되는 경기 스케쥴이 있습니다.
- 좌측 하단에는 유저 / 투수 / 타자별로 랭킹을 확인할 수 있으며, 랭킹은 어제자 기준입니다.
- 게임이 시작되는 COUNTDOWN TIMER를 통해 게임 시작 및 베팅 시작 시간을 알 수 있습니다.
- 베팅이 시작되기 전에는 `BETTING RESULT` 버튼이 노출되며 어제자 베팅 기록 결과 페이지로 이동합니다.
- 게임 및 베팅이 시작되면 COUNTDOWN TIMER가 0이 되면서 `BETTING START` 버튼으로 변경됩니다.
- 베팅은 한 시간 동안 진행되며, 이후 베팅 가능 시간이 종료되면 `BETTING CLOSED`라는 글자로 변경됩니다.
- 경기가 종료된 이후 밤 12시 30분 ~ 새벽 4시 사이에 경기 결과를 바탕으로 베팅 금액이 정산되며, 이때 `SCORE CALCULATING`이라는 글자가 나타납니다.

### 베팅 등록

- 베팅 등록 페이지에서는 유저가 원하는 로스터로 베팅을 등록할 수 있습니다.
- 경기가 시작되기 전 올라오는 선발 라인업을 기준으로 1군 엔트리 리스트를 보여줍니다.
- 1군 엔트리 리스트에서 `INFO` 링크를 클릭하면 KBO 사이트의 해당 선수 상세 정보 페이지로 연결됩니다.
- `ADD` 아이콘을 클릭하면 해당 선수가 로스터에 등록되며, 우측 로스터 영역에서 확인할 수 있습니다.
- 엔트리 하단의 `RANDOM ROASTER`를 클릭하면 랜덤으로 로스터에 선수들이 등록됩니다.
- `CHECK LATEST STATISTICS`를 클릭하면 가장 최근의 선수들의 스코어 순위 페이지로 이동합니다.
- 10명의 선수들을 로스터에 등록하고 원하는 액수 만큼 베팅 금액을 입력한 후 `BETTING`을 클릭하면 성공적으로 베팅이 등록됩니다.
- 경기가 있는 날 베팅은 단 한 번 가능하며, 베팅을 다시 등록하게 되면 이미 등록된 베팅이라는 안내 문구가 출력됩니다.

### 베팅 결과

- 베팅에 참여한 결과를 볼 수 있는 페이지입니다.
- 베팅의 상위 유저 랭킹 3명과 자신의 순위, 획득 금액 및 등록했던 로스터를 확인할 수 있습니다.
- `CHECK PLAYERS STATISTIC` 버튼을 통해 해당 날짜의 선수별 통계를 볼 수 있습니다.

### 베팅 이력

### 선수별 통계

- 포지션 별 선수들의 스코어 통계를 확인할 수 있습니다.
- 스코어 순으로 정렬된 그래프를 볼 수 있으며, 각 선수들에게 베팅한 유저수도 나타납니다.

## 베팅 알고리즘

### 선수 스코어 계산 방법
 - 선발 선수들의 게임 성적으로 스코어를 계산합니다.
 - 배점 항목과 점수는 [컴투스 프로야구 포인트](http://cpbpoint.mbcplus.com/about/cpbpoint/)를 참고하였습니다.
 - 선수들의 성적은 경기 종료 후 KBO에 공개되는 데이터를 이용하였습니다.
 - 본 프로젝트의 배점 항목은 KBO에서 제공하는 데이터에 맞게 재구성하였습니다.
 - 선수들의 포지션은 크게 타자와 투수로 나뉘며, 배점 항목에 차이가 있습니다.
 - 타자는 타석, 1루타, 2루타, 삼진 등의 항목이 있습니다.
 - 투수는 이닝, 승, 패, 탈삼진 등의 항목이 있습니다.
#### 타자
| 항목 | 코드 | 포인트 |
|---|:---:|---:|
| `타석` | PA | 1 |
| `타점` | RBI | 10 |
| `득점` | R | 5 |
| `1루타` | SINGLE | 10 |
| `2루타` | DOUBLE | 20 |
| `3루타` | TRIPLE | 30 |
| `홈런` | HOMERUN | 50 |
| `희생타` | SH | 5 |
| `4사구` | BB | 5 |
| `고의사구` | IBB | 10 |
| `아웃` | Out | -5 |
| `삼진` | SO | -10 |
| `사이클링히트` | CH | 100 |
| `결승타` | WH | 20 |
| `주루사/견제사` | RO | -5 |
| `병살타` | DP | -10 |
| `도루` | SB | 10 |
| `도루자(도루실패)` | CS | -5 |
| `실책` | Err | -10 |
#### 투수
| 항목 | 코드 | 포인트 |
|---|:---:|---:|
| `승` | Wgs | 125 |
| `패` | L | -25 |
| `이닝` | IP | 12 |
| `피안타` | H | -7 |
| `피홈런` | HR | -10 |
| `4사구` | BB | -5 |
| `탈삼진` | SO | 10 |
| `실점` | R | -5 |
| `자책점` | ER | -10 |
| `폭투` | WP | -5 |
| `보크` | BK | -5 |
| `QS` | QS | 10 |
| `QS+` | QSP | 20 |
| `완봉` | SHO | 50 |
| `완투` | CG | 25 |
| `노히트노런` | NHG | 100 |
| `퍼펙트게임` | PFG | 200 |
#### 예시
- 김선수(타자)
| 항목(개수) | 코드 | 포인트 |
|---|:---:|---:|
| `도루` | SB | 10 |
| `유땅` | Out | -5 |
| `좌홈` | HR | 50 |
| `우안` | SINGLE | 10 |
| `우3` | TRIPLE | 30 |
| `중2` | DOUBLE | 20 |
| `타점(6)` | RBI | 6 * 10 |
| `득점(3)` | R | 3 * 5 |
| `사이클링히트` | CH | 100 |
| `타석(5)` | PA | 5 * 1 |
| 총합 |  | 295 |

### 배당금 계산 방법

1. 로스터 구성 방법

- FANTASY BASEBALL은 10인으로 이루어진 로스터에 유저가 자신이 원하는 만큼 베팅 금액을 걸 수 있는 구조입니다.
- 유저가 선택할 수 있는 선수들 리스트는 당일 선발 라인업을 기준으로 각 팀당 10명 씩 총 100명이 매일 갱신됩니다.
- 로스터로 선택할 수 있는 10인은 좌익수, 중견수, 우익수, 1루수, 2루수, 3루수, 유격수, 투수, 포수, 지명타자 등 각각의 포지션을 가지고 있습니다.
- 원하는 로스터를 구성한 후 최소 100원 이상 최대 자신이 가진 금액까지 100 단위로 베팅 금액을 설정합니다.

2-1. 배당금 계산 방식

- 모든 경기가 종료된 후 나온 결과를 바탕으로 선수들의 스코어를 계산합니다.
- 포지션 별로 선수들을 1등부터 10등까지 정렬합니다.
- 유저들의 배당금은 포지션 별로 계산되며, 베팅 금액은 총 포지션의 갯수인 1/10로 산정합니다.
- 유저들이 베팅한 선수들 한정으로 가장 높은 스코어를 기록한 1등과 2등 선수를 선별합니다.
- 1등과 2등 선수를 로스터에 포함한 유저들은 자신의 베팅 금액 만큼 돌려 받습니다.
- 1등과 2등 이외의 선수들에게 걸린 금액을 모두 합한 후 1등을 선택한 유저들에게는 70%, 2등을 선택한 유저들에게는 30%를 돌려줍니다.
- 이때, 1등과 2등 유저들 각각의 총 베팅 금액에 대한 자신이 베팅한 금액의 비율만큼 추가로 돈을 얻게 됩니다.

2-2. 배당금 계산 예시

```
// 선수명 / 스코어 / 유저명 - 포지션 별 베팅금액

[타자]
Player 1 : 160
player 2 : 140 / User 1 - 500, User 2 - 1000
Player 3 : 100 / User 3 - 500
Player 4 : 55 / User 4 - 300
Player 5 : 20 / User 5 - 1000, User 6 - 2000
Player 6 : 0
Player 7 : -10
Player 8 : -15 / User 6 - 100
Player 9 : -30
Player 10 : -33 / User 7 - 100

** 타자 포지션에 걸린 총 베팅 금액 : 5500
** 1등인 Player 2, 2등인 Player 3를 선택한 유저들은 자신의 배당금을 돌려 받음

** 1등, 2등을 제외한 나머지 선수들에게 걸린 총 베팅 금액 : 3500
** 1등 선수를 선택한 유저들이 추가로 얻는 총 금액 : 3500 * 70% = 2450
** 2등 선수를 선택한 유저들이 추가로 얻는 총 금액 : 3500 * 30% = 1050
** 1등 선수를 선택한 각각의 유저들이 얻는 금액
   User 1 : 500 / 1500 = 1/3 -> 2450 * 1/3 = 817 (반올림)
   User 2 : 1000 / 1500 = 2/3 -> 2450 * 2/3 = 1633 (반올림)
** 2등 선수를 선택한 각각의 유저들이 얻는 금액
   User 3 : 500 / 500 = 1 -> 1050 * 1 = 1050

** 유저 별 총 획득 금액
   User 1 : 500 + 817 = 1317
   User 2 : 1000 + 1633 = 2633
   User 3 : 500 + 1050 = 1550
   (3 ~ 10등 선수를 선택한 유저는 돈을 획득하지 못함)
```

## 개발 중 이슈

1. Frontend / Backend에서 시간을 다루는 방법

- 당일 및 과거의 데이터를 쉽게 조회하기 위해 DB에 `gameDate`라는 필드를 통해 접근하는 방식을 선택하였습니다. 현재 또는 과거 날짜를 `date-fns` 라이브러리를 사용해 형식을 `String`으로 바꾼 후 저장하였는데, 서버에서 날짜 / 시간을 저장하는 방식이 달라 로직을 작성하는 데 어려움을 겪었습니다.
- 크롤링, 메일링 등을 위한 스케쥴링 작업에서도 관련 이슈를 겪었습니다. AWS에서 서버를 배포할 때 `node-schedule-tz` 라이브러리를 사용하였는데, 로컬에서는 정상적으로 로컬 타임 기준으로 작동하였지만 AWS는 UTC가 기준이 되어 예상한 대로 스케쥴링이 진행되지 않았습니다.
- `Date` 객체를 다루면서 Local Time이 아니라 `ISO`를 기준으로 날짜 및 시간을 저장하는 것의 중요성을 알게 되었습니다.

2. 베팅 금액 로직

- 처음 베팅 금액을 유저들에게 분배하는 로직을 구성할 때 포지션 별로 선수들을 나눈 후 포지션 별 총 스코어에 해당하는 선수들의 스코어 비율만큼 베팅 금액을 획득하는 방식을 채택하였습니다.
- 이후 로직을 점검하면서 유저들이 건 베팅 금액이 크더라도 그에 비례하는 이익을 얻지 못한다는 것을 발견하였습니다.
- 더 많은 베팅 금액을 걸었을 때 더 많은 이익을 낼 수 있도록 로직을 수정하면서, DB를 재가공하고 다양한 종류의 Model에 접근하여 DB를 업데이트하게 되었습니다. 이를 통해 Mongoose의 `aggregate` 및 `transaction`을 다양하게 사용할 수 있는 기회가 되었습니다.

3. 크롤링

- 경기 결과 반영 시 발생한 이슈
- 당일 경기 일정 중 경기가 취소된 경우 발생한 이슈
- 동명이인 처리

4. 로그인

5. 스케쥴링 / 로그

## 테스트
- Frontend: Cypress
- Backend: Jest, Mocha

## 지원하는 브라우저

- Chrome
- Safari

## 버전
